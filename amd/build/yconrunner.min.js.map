{"version":3,"file":"yconrunner.min.js","sources":["../src/yconrunner.js"],"sourcesContent":["define(['jquery', 'core/log', 'qtype_yconrunner/ace_wrapper'], function ($, log, acePromise) {\n    return {\n        init: function (params) {\n            $(document).ready(function () {\n                var questions = document.querySelectorAll('.que');\n\n                questions.forEach(function(question) {\n                    // Проверяем, есть ли в этом вопросе кнопка с текстом \"Проверить\"\n                    var verifyButton = question.querySelector('button');\n                    if (verifyButton && verifyButton.textContent.trim() === 'Проверить') {\n                        // Если есть, ищем кнопку \"Check\" в том же вопросе и скрываем её\n                        var checkButton = question.querySelector('.im-controls');\n                        if (checkButton) {\n                            checkButton.style.display = 'none';\n                        }\n                    }\n                });\n\n                // Загрузка данных из API\n                fetch(`http://localhost:3000/api/contests/${params.contestid}/problems/${params.submissionid}/statement`)\n                    .then(response => response.text())\n                    .then(data => {\n                        log.debug('Received problem statement:', data);\n                        $('#question-text').html(data);\n                    })\n                    .catch(error => log.error('Ошибка при получении описания проблемы', error));\n\n                // Использование ACE из нашего обёрточного модуля\n                acePromise.then(function (ace) {\n                    log.debug('ACE loaded successfully');\n                    var editor = ace.edit(\"editor\");\n                    editor.setTheme(\"ace/theme/monokai\");\n                    editor.session.setMode(\"ace/mode/python\");\n                    editor.setOptions({\n                        fontSize: \"18px\"\n                    });\n\n                    // Предотвращаем добавление Ace Editor обработчиков beforeunload\n                    editor.$blockScrolling = Infinity;\n\n                    // Удаляем обработчик события beforeunload, если он был добавлен\n                    window.onbeforeunload = null;\n\n                    // Предотвращаем срабатывание других обработчиков beforeunload\n                    window.addEventListener('beforeunload', function(e) {\n                        e.stopImmediatePropagation();\n                    }, true);\n\n                    $('#language-select').change(function () {\n                        var language = $(this).val();\n                        switch (language) {\n                            case 'python':\n                                editor.session.setMode(\"ace/mode/python\");\n                                break;\n                            case 'cpp':\n                                editor.session.setMode(\"ace/mode/c_cpp\");\n                                break;\n                            case 'java':\n                                editor.session.setMode(\"ace/mode/java\");\n                                break;\n                            case 'csharp':\n                                editor.session.setMode(\"ace/mode/csharp\");\n                                break;\n                        }\n                    });\n\n                    $('#file-upload')\n                        .after('<button type=\"button\" id=\"remove-file\" class=\"btn btn-danger ml-2\">Удалить файл</button>');\n\n                    // Обработчик для удаления файла\n                    $('#remove-file').click(function () {\n                        $('#file-upload').val(null);\n                        window.onbeforeunload = null;\n                    });\n\n                    $('#submit-button').click(function () {\n                        // Удаляем все обработчики событий на уход со страницы\n                        window.onbeforeunload = null;\n\n                        // Предотвращаем срабатывание других обработчиков beforeunload\n                        window.addEventListener('beforeunload', function(e) {\n                            e.stopImmediatePropagation();\n                        }, true);\n\n                        let answer = editor.getValue();\n                        let language = $('#language-select').val();\n                        let extension;\n                        let commentPrefix;\n\n                        // Определение расширения файла и префикса комментария\n                        switch (language) {\n                            case 'python':\n                                extension = '.py';\n                                commentPrefix = '#';\n                                break;\n                            case 'cpp':\n                                extension = '.cpp';\n                                commentPrefix = '//';\n                                break;\n                            case 'java':\n                                extension = '.java';\n                                commentPrefix = '//';\n                                break;\n                            case 'csharp':\n                                extension = '.cs';\n                                commentPrefix = '//';\n                                break;\n                        }\n\n                        // Генерация случайного числа и добавление его в качестве комментария\n                        let randomNumber = Math.floor(Math.random() * 1000000);\n                        let randomComment = `${commentPrefix} Random number: ${randomNumber}\\n`;\n                        answer = randomComment + answer;\n\n                        let contestid = params.contestid;\n                        let fileInput = $('#file-upload')[0];\n                        let formData = new FormData();\n\n                        if (fileInput.files.length > 0) {\n                            // Если файл загружен, добавляем комментарий к содержимому файла\n                            let file = fileInput.files[0];\n                            let reader = new FileReader();\n                            reader.onload = function (e) {\n                                let content = e.target.result;\n                                let modifiedContent = randomComment + content;\n                                formData.append('file', new Blob([modifiedContent], {type: 'text/plain'}), 'main' + extension);\n                                sendRequest(formData, language, contestid);\n                            };\n                            reader.readAsText(file);\n                        } else {\n                            // Если файл не загружен, используем текст из редактора\n                            formData.append('code', answer);\n                            formData.append('extension', extension);\n                            sendRequest(formData, language, contestid);\n                        }\n                    });\n\n                    // Функция для отправки запроса на сервер\n                    function sendRequest(formData, language, contestid) {\n                        formData.append('compiler', language === 'python' ? 'python3' :\n                            (language === 'cpp' ? 'gcc_cpp20' : (language === 'java' ? 'javac' : 'mcs')));\n                        formData.append('problem', 'A'); // Пример использования submissionid в качестве problem\n\n                        const requestOptions = {\n                            method: \"POST\",\n                            headers: {\n                                // Добавьте необходимые заголовки\n                            },\n                            body: formData,\n                            redirect: \"follow\"\n                        };\n\n                        fetch(`http://localhost:3000/api/contests/${contestid}/submissions`, requestOptions)\n                            .then(response => response.json())\n                            .then(result => {\n                                log.debug(result);\n\n                                // Получение вердикта из ответа\n                                let verdict = result.verdict;\n\n                                // Отображение сообщения пользователю\n                                $('#result-message').text(verdict).show();\n\n                                // Отправка результата на сервер Moodle для оценки\n                                $.ajax({\n                                    url: M.cfg.wwwroot + '/question/type/yconrunner/grade_response.php',\n                                    method: 'POST',\n                                    contentType: 'application/json',\n                                    data: JSON.stringify({result: verdict === 'OK' ? 1 : 0, attemptid: params.attemptid}),\n                                    success: function (response) {\n                                        log.debug('Оценка успешно сохранена', response);\n                                        $('#file-upload').val(null); // Удаление файла из прикрепления\n\n                                        // Сообщаем Moodle, что форма была отправлена\n                                        var form = document.getElementById('responseform');\n                                        if (form && M && M.core_formchangechecker) {\n                                            M.core_formchangechecker.set_form_submitted();\n                                        }\n\n                                        // Удаляем обработчик события beforeunload\n                                        window.onbeforeunload = null;\n\n                                        // Предотвращаем срабатывание других обработчиков beforeunload\n                                        window.addEventListener('beforeunload', function(e) {\n                                            e.stopImmediatePropagation();\n                                        }, true);\n\n                                        // Перезагружаем страницу\n                                        window.location.reload();\n                                    },\n                                    error: function (error) {\n                                        log.error('Ошибка при сохранении оценки:', error);\n                                        $('#file-upload').val(null);\n\n                                        // Аналогичные действия\n                                        var form = document.getElementById('responseform');\n                                        if (form && M && M.core_formchangechecker) {\n                                            M.core_formchangechecker.set_form_submitted();\n                                        }\n\n                                        window.onbeforeunload = null;\n                                        window.addEventListener('beforeunload', function(e) {\n                                            e.stopImmediatePropagation();\n                                        }, true);\n\n                                        window.location.reload();\n                                    }\n                                });\n                            })\n                            .catch(error => {\n                                log.debug(error);\n                                $('#result-message').text('Произошла ошибка при отправке решения.').show();\n\n                                // Отправка результата на сервер Moodle для оценки с результатом 0\n                                $.ajax({\n                                    url: M.cfg.wwwroot + '/question/type/yconrunner/grade_response.php',\n                                    method: 'POST',\n                                    contentType: 'application/json',\n                                    data: JSON.stringify({result: 0, attemptid: params.attemptid}),\n                                    success: function (response) {\n                                        log.debug('Оценка успешно сохранена', response);\n                                        $('#file-upload').val(null);\n\n                                        var form = document.getElementById('responseform');\n                                        if (form && M && M.core_formchangechecker) {\n                                            M.core_formchangechecker.set_form_submitted();\n                                        }\n\n                                        window.onbeforeunload = null;\n                                        window.addEventListener('beforeunload', function(e) {\n                                            e.stopImmediatePropagation();\n                                        }, true);\n\n                                        window.location.reload();\n                                    },\n                                    error: function (error) {\n                                        log.error('Ошибка при сохранении оценки:', error);\n                                        $('#file-upload').val(null);\n\n                                        var form = document.getElementById('responseform');\n                                        if (form && M && M.core_formchangechecker) {\n                                            M.core_formchangechecker.set_form_submitted();\n                                        }\n\n                                        window.onbeforeunload = null;\n                                        window.addEventListener('beforeunload', function(e) {\n                                            e.stopImmediatePropagation();\n                                        }, true);\n\n                                        window.location.reload();\n                                    }\n                                });\n                            });\n                    }\n                }).catch(function (error) {\n                    log.error('Failed to load ACE:', error);\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","log","acePromise","init","params","document","ready","querySelectorAll","forEach","question","verifyButton","querySelector","textContent","trim","checkButton","style","display","fetch","contestid","submissionid","then","response","text","data","debug","html","catch","error","ace","editor","edit","sendRequest","formData","language","append","method","headers","body","redirect","json","result","verdict","show","ajax","url","M","cfg","wwwroot","contentType","JSON","stringify","attemptid","success","val","getElementById","core_formchangechecker","set_form_submitted","window","onbeforeunload","addEventListener","e","stopImmediatePropagation","location","reload","setTheme","session","setMode","setOptions","fontSize","$blockScrolling","Infinity","change","this","after","click","extension","commentPrefix","answer","getValue","randomComment","Math","floor","random","fileInput","FormData","files","length","file","reader","FileReader","onload","content","target","modifiedContent","Blob","type","readAsText"],"mappings":"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"}