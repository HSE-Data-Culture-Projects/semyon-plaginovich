{"version":3,"file":"yconrunner.min.js","sources":["../src/yconrunner.js"],"sourcesContent":["define(['jquery', 'core/log', 'qtype_yconrunner/ace_wrapper'], function ($, log, acePromise) {\n    return {\n        init: function (params) {\n            $(document).ready(function () {\n                var questions = document.querySelectorAll('.que');\n\n                questions.forEach(function(question) {\n                    // Проверяем, есть ли в этом вопросе кнопка с текстом \"Проверить\"\n                    var verifyButton = question.querySelector('button');\n                    if (verifyButton && verifyButton.textContent.trim() === 'Проверить') {\n                        // Если есть, ищем кнопку \"Check\" в том же вопросе и скрываем её\n                        var checkButton = question.querySelector('.im-controls');\n                        if (checkButton) {\n                            checkButton.style.display = 'none';\n                        }\n                    }\n                });\n\n                // Загрузка данных из API\n                fetch(`http://localhost:3000/api/contests/${params.contestid}/problems/${params.submissionid}/statement`)\n                    .then(response => response.text())\n                    .then(data => {\n                        log.debug('Received problem statement:', data);\n                        $('#question-text').html(data);\n                    })\n                    .catch(error => log.error('Ошибка при получении описания проблемы', error));\n\n                // Использование ACE из нашего обёрточного модуля\n                acePromise.then(function (ace) {\n                    log.debug('ACE loaded successfully');\n                    var editor = ace.edit(\"editor\");\n                    editor.setTheme(\"ace/theme/monokai-light\");\n                    editor.session.setMode(\"ace/mode/python\");\n                    editor.setOptions({\n                        fontSize: \"18px\"\n                    });\n\n                    $('#language-select').change(function () {\n                        var language = $(this).val();\n                        switch (language) {\n                            case 'python':\n                                editor.session.setMode(\"ace/mode/python\");\n                                break;\n                            case 'cpp':\n                                editor.session.setMode(\"ace/mode/c_cpp\");\n                                break;\n                            case 'java':\n                                editor.session.setMode(\"ace/mode/java\");\n                                break;\n                            case 'csharp':\n                                editor.session.setMode(\"ace/mode/csharp\");\n                                break;\n                        }\n                    });\n\n                    $('#file-upload').after('<button type=\"button\" id=\"remove-file\" class=\"btn btn-danger ml-2\">Удалить файл</button>');\n\n                    // Обработчик для удаления файла\n                    $('#remove-file').click(function () {\n                        $('#file-upload').val(null);\n                        window.onbeforeunload = null;\n                    });\n\n                    $('#submit-button').click(function () {\n                        // Удаляем все обработчики событий на уход со страницы\n                        window.onbeforeunload = null;\n\n                        let answer = editor.getValue();\n                        let language = $('#language-select').val();\n                        let extension;\n                        let commentPrefix;\n\n                        // Определение расширения файла и префикса комментария\n                        switch (language) {\n                            case 'python':\n                                extension = '.py';\n                                commentPrefix = '#';\n                                break;\n                            case 'cpp':\n                            case 'java':\n                            case 'csharp':\n                                extension = language === 'cpp' ? '.cpp' : (language === 'java' ? '.java' : '.cs');\n                                commentPrefix = '//';\n                                break;\n                        }\n\n                        // Генерация случайного числа и добавление его в качестве комментария\n                        let randomNumber = Math.floor(Math.random() * 1000000);\n                        let randomComment = `${commentPrefix} Random number: ${randomNumber}\\n`;\n                        answer = randomComment + answer;\n\n                        let contestid = params.contestid;\n                        let fileInput = $('#file-upload')[0];\n                        let formData = new FormData();\n\n                        if (fileInput.files.length > 0) {\n                            // Если файл загружен, добавляем комментарий к содержимому файла\n                            let file = fileInput.files[0];\n                            let reader = new FileReader();\n                            reader.onload = function (e) {\n                                let content = e.target.result;\n                                let modifiedContent = randomComment + content;\n                                formData.append('file', new Blob([modifiedContent], {type: 'text/plain'}), 'main' + extension);\n                                sendRequest(formData, language, contestid);\n                            };\n                            reader.readAsText(file);\n                        } else {\n                            // Если файл не загружен, используем текст из редактора\n                            let file = new Blob([answer], {type: 'text/plain'});\n                            formData.append('file', file, 'main' + extension);\n                            sendRequest(formData, language, contestid);\n                        }\n                    });\n\n                    function sendRequest(formData, language, contestid) {\n                        formData.append('compiler', language === 'python' ? 'python3' : (language === 'cpp' ? 'gcc_cpp20' : (language === 'java' ? 'javac' : 'mcs')));\n                        formData.append('problem', 'A'); // Пример использования submissionid в качестве problem\n\n                        const myHeaders = new Headers();\n                        myHeaders.append(\"Authorization\", \"OAuth y0_AgAEA7qkKGeUAAv6MwAAAAEIAX7dAABWL6qZvrJOUJvQhMBpgC27VCKHrg\");\n\n                        const requestOptions = {\n                            method: \"POST\",\n                            headers: myHeaders,\n                            body: formData,\n                            redirect: \"follow\"\n                        };\n\n                        fetch(`http://localhost:3000/api/contests/${contestid}/submissions`, requestOptions)\n                            .then(response => response.json())\n                            .then(result => {\n                                log.debug(result);\n\n                                // Получение вердикта из ответа\n                                let verdict = result.verdict;\n\n                                // Отображение сообщения пользователю\n                                $('#result-message').text(verdict).show();\n\n                                // Отправка результата на сервер Moodle для оценки\n                                $.ajax({\n                                    url: M.cfg.wwwroot + '/question/type/yconrunner/grade_response.php',\n                                    method: 'POST',\n                                    contentType: 'application/json',\n                                    data: JSON.stringify({result: verdict === 'OK' ? 1 : 0, attemptid: params.attemptid}),\n                                    success: function (response) {\n                                        log.debug('Оценка успешно сохранена', response);\n                                        $('#file-upload').val(null); // Удаление файла из прикрепления\n                                        window.onbeforeunload = null;\n                                    },\n                                    error: function (error) {\n                                        log.error('Ошибка при сохранении оценки:', error);\n                                        $('#file-upload').val(null); // Удаление файла из прикрепления\n                                        window.onbeforeunload = null;\n                                    }\n                                });\n                            })\n                            .catch(error => {\n                                log.debug(error);\n                                $('#result-message').text('Произошла ошибка при отправке решения.').show();\n                                // Отправка результата на сервер Moodle для оценки\n                                $.ajax({\n                                    url: M.cfg.wwwroot + '/question/type/yconrunner/grade_response.php',\n                                    method: 'POST',\n                                    contentType: 'application/json',\n                                    data: JSON.stringify({result: 0, attemptid: params.attemptid}),\n                                    success: function (response) {\n                                        log.debug('Оценка успешно сохранена', response);\n                                        $('#file-upload').val(null); // Удаление файла из прикрепления\n                                        window.onbeforeunload = null;\n                                    },\n                                    error: function (error) {\n                                        log.error('Ошибка при сохранении оценки:', error);\n                                        $('#file-upload').val(null); // Удаление файла из прикрепления\n                                        window.onbeforeunload = null;\n                                    }\n                                });\n                            });\n                    }\n                }).catch(function (error) {\n                    log.error('Failed to load ACE:', error);\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","log","acePromise","init","params","document","ready","querySelectorAll","forEach","question","verifyButton","querySelector","textContent","trim","checkButton","style","display","fetch","contestid","submissionid","then","response","text","data","debug","html","catch","error","ace","editor","edit","sendRequest","formData","language","append","myHeaders","Headers","method","headers","body","redirect","json","result","verdict","show","ajax","url","M","cfg","wwwroot","contentType","JSON","stringify","attemptid","success","val","window","onbeforeunload","setTheme","session","setMode","setOptions","fontSize","change","this","after","click","extension","commentPrefix","answer","getValue","randomComment","Math","floor","random","fileInput","FormData","files","length","file","reader","FileReader","onload","e","content","target","modifiedContent","Blob","type","readAsText"],"mappings":"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"}